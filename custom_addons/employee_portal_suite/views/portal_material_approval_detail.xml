<?xml version="1.0" encoding="UTF-8"?>
<odoo>

        <template id="portal_material_approval_detail" name="Material Approval Detail">
        <t t-call="employee_portal_suite.employee_portal_layout">

        <div class="container mt-3 employee-req-detail">

            <!-- ========================= -->
            <!-- BACK BUTTON -->
            <!-- ========================= -->
            <div class="mb-4">
                <a href="/my/employee/material/approvals" class="app-back-btn">
                    <i class="fa fa-arrow-left"></i>
                    <span>Back</span>
                </a>
            </div>

            <!-- ========================= -->
            <!-- PAGE HEADER -->
            <!-- ========================= -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-0 fw-bold">Material Approval</h4>
                    <div class="text-muted small">
                        <t t-esc="request_rec.name"/>
                    </div>
                </div>

                <div class="text-end">
                    <t t-raw="status_badge(request_rec)"/>

                    <t t-if="request_rec.state in ['approved','rejected']">
                        <a t-att-href="'/my/employee/material/pdf/%s' % request_rec.id"
                        class="btn btn-sm btn-outline-primary mt-2">
                            Download PDF
                        </a>
                    </t>
                </div>
            </div>

            <!-- ========================= -->
            <!-- ALERTS -->
            <!-- ========================= -->

            <t t-if="request_rec.state == 'rejected'">
                <div class="alert alert-danger small">
                    <strong>Rejected at:</strong>
                    <t t-esc="request_rec.state_before_reject"/> â€”
                    <strong>Reason:</strong>
                    <t t-esc="request_rec.get_rejection_reason()"/>
                </div>
            </t>

            <t t-if="request_rec.needs_clarification and request_rec.clarification_stage">
                <div class="alert alert-warning small">
                    <strong>
                        Clarification requested by 
                        <t t-esc="dict(request_rec._fields['state'].selection).get(request_rec.clarification_stage)"/>.
                    </strong>
                </div>
            </t>

            <!-- ========================= -->
            <!-- OVERVIEW CARD -->
            <!-- ========================= -->
            <div class="card mb-3 rounded-4 shadow-sm">
                <div class="card-body small">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-muted">Employee</div>
                            <div class="fw-semibold">
                                <t t-esc="request_rec.employee_id.name"/>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted">Worksite</div>
                            <div class="fw-semibold">
                                <t t-esc="request_rec.worksite"/>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted">Request Date</div>
                            <div class="fw-semibold">
                                <t t-esc="request_rec.request_date"/>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted">Delivery Date</div>
                            <div class="fw-semibold">
                                <t t-esc="request_rec.delivery_date"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================= -->
            <!-- MATERIAL LIST -->
            <!-- ========================= -->
            <div class="card mb-3 rounded-4 shadow-sm">
                <div class="card-header bg-white fw-semibold">
                    Requested Materials
                </div>
                <div class="list-group list-group-flush small">
                    <t t-foreach="request_rec.line_ids" t-as="line">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">
                                    <t t-esc="line.item_name"/>
                                </div>
                                <div class="text-muted small">
                                    <t t-esc="line.uom_id.name"/>
                                </div>
                            </div>
                            <div class="fw-bold fs-6">
                                <t t-esc="line.qty_required"/>
                            </div>
                        </div>
                    </t>
                </div>
            </div>

            <!-- ========================= -->
            <!-- ATTACHMENTS -->
            <!-- ========================= -->
            <div class="card mb-3 rounded-4 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <span class="fw-semibold">Attachments</span>
                    <span class="badge bg-light text-dark">
                        <t t-esc="len(attachments)"/>
                    </span>
                </div>

                <div class="card-body p-0">

                    <t t-if="attachments">
                        <div class="list-group list-group-flush small">
                            <t t-foreach="attachments" t-as="att">
                                <div class="list-group-item">

                                    <div class="d-flex justify-content-between align-items-center">

                                        <div class="overflow-hidden">
                                            <div class="fw-semibold text-truncate">
                                                <t t-esc="att.name"/>
                                            </div>
                                            <div class="text-muted small">
                                                <t t-esc="att.description or 'General'"/>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">

                                            <a t-att-href="'/web/content/%s' % att.id"
                                            target="_blank"
                                            class="attachment-icon-btn text-primary">
                                                <i class="fa fa-eye"></i>
                                            </a>

                                            <a t-att-href="'/web/content/%s?download=true' % att.id"
                                            target="_blank"
                                            class="attachment-icon-btn text-secondary">
                                                <i class="fa fa-download"></i>
                                            </a>

                                            <a href="#"
                                            class="attachment-icon-btn text-danger delete-trigger"
                                            t-att-data-url="'/my/employee/material/attachment/delete/%s/%s' % (att.id, request_rec.id)">
                                                <i class="fa fa-times"></i>
                                            </a>

                                        </div>
                                    </div>

                                    <!-- Delete Confirmation -->
                                    <div class="delete-confirmation d-none mt-3">
                                        <div class="confirm-box p-3 rounded-3">
                                            <div class="small mb-2 text-muted">
                                                Delete this attachment?
                                            </div>
                                            <div class="d-flex gap-2 justify-content-end">
                                                <button type="button"
                                                        class="btn btn-sm btn-light cancel-delete">
                                                    Cancel
                                                </button>
                                                <a href="#"
                                                class="btn btn-sm btn-danger confirm-delete">
                                                    Delete
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </t>
                        </div>
                    </t>

                    <t t-else="">
                        <div class="p-3 text-muted small">
                            No attachments uploaded.
                        </div>
                    </t>

                </div>
            </div>
            <!-- ========================= -->
                <!-- UPLOAD SECTION -->
                <!-- ========================= -->

                <div class="card mb-3 rounded-4 shadow-sm">
                    <div class="card-header bg-white fw-semibold">
                        Upload New Attachments
                    </div>

                    <div class="card-body small">

                        <form method="post"
                            action="/my/employee/material/attachment/upload"
                            enctype="multipart/form-data">

                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input type="hidden" name="req_id" t-att-value="request_rec.id"/>

                            <select name="attachment_tag" class="form-select mb-3">
                                <option value="General">General</option>
                                <option value="BOQ">BOQ</option>
                                <option value="Quotation">Quotation</option>
                                <option value="Image">Image</option>
                                <option value="Receipt">Receipt</option>
                            </select>

                            <div id="dropzone-detail"
                                class="border rounded-4 p-4 text-center bg-light mb-3"
                                style="cursor:pointer;">
                                <div class="text-muted small">
                                    Drag files here or click to upload
                                </div>
                                <input type="file"
                                    name="attachments"
                                    id="fileInput-detail"
                                    class="d-none"
                                    multiple="multiple"/>
                            </div>

                            <div id="previewArea-detail"></div>

                            <button type="submit" class="btn btn-primary w-100">
                                Upload
                            </button>

                        </form>

                    </div>
                </div>
            <!-- ========================= -->
            <!-- APPROVAL ACTION -->
            <!-- ========================= -->

            <t t-if="request_rec.state in ['purchase','store','project_manager','director','ceo']">

                <div class="card mb-3 rounded-4 shadow-sm">
                    <div class="card-header bg-white fw-semibold">
                        Approval Action
                    </div>

                    <div class="card-body small">

                        <!-- Clarification Switch -->
                        <t t-if="request_rec.can_toggle_clarification">
                            <form method="post"
                                action="/my/employee/material/requests/set_clarification"
                                class="mb-4">

                                <input type="hidden" name="csrf_token"
                                    t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="req_id"
                                    t-att-value="request_rec.id"/>

                                <div class="form-check form-switch">
                                    <input class="form-check-input"
                                        type="checkbox"
                                        name="flag"
                                        onchange="this.form.submit()"
                                        t-att-checked="request_rec.needs_clarification and 'checked' or None"/>
                                    <label class="form-check-label small">
                                        Needs Clarification
                                    </label>
                                </div>
                            </form>
                        </t>

                        <!-- Comment -->
                        <textarea class="form-control mb-3"
                                name="comment"
                                form="approveForm"
                                placeholder="Add comment (optional)"></textarea>

                        <!-- Buttons Row -->
                        <div class="d-flex gap-2 justify-content-end">

                            <form id="rejectForm"
                                action="/my/employee/material/requests/reject"
                                method="post"
                                class="m-0">

                                <input type="hidden" name="csrf_token"
                                    t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="req_id"
                                    t-att-value="request_rec.id"/>

                                <button type="submit"
                                        class="btn btn-outline-danger px-4">
                                    Reject
                                </button>
                            </form>

                            <form id="approveForm"
                                action="/my/employee/material/requests/approve"
                                method="post"
                                class="m-0">

                                <input type="hidden" name="csrf_token"
                                    t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="req_id"
                                    t-att-value="request_rec.id"/>

                                <button type="submit"
                                        class="btn btn-success px-4">
                                    Approve
                                </button>
                            </form>

                        </div>

                    </div>
                </div>

            </t>


            <!-- ========================= -->
            <!-- TIMELINE -->
            <!-- ========================= -->
            <div class="card mb-3 rounded-4 shadow-sm">
                <div class="card-header bg-white fw-semibold">
                    Approval Timeline
                </div>

                <div class="card-body small">

                    <t t-if="request_rec.get_portal_timeline()">
                        <ul class="timeline">
                            <t t-foreach="request_rec.get_portal_timeline()" t-as="ev">
                                <li class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <div class="fw-semibold">
                                            <t t-esc="ev['stage']"/>
                                        </div>
                                        <div class="text-muted small">
                                            <t t-esc="ev['date']"/>
                                        </div>
                                        <t t-if="ev['comment']">
                                            <div class="small mt-1">
                                                <t t-esc="ev['comment']"/>
                                            </div>
                                        </t>
                                    </div>
                                </li>
                            </t>
                        </ul>
                    </t>

                    <t t-if="not request_rec.get_portal_timeline()">
                        <div class="text-muted small">
                            No approval activity yet.
                        </div>
                    </t>

                </div>
            </div>

        </div>


        <!-- TIMELINE CSS (ADDED) -->
        <style>
            .timeline {
                list-style: none;
                padding-left: 20px;
                position: relative;
                margin-left: 10px;
            }

            .timeline:before {
                content: "";
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: #c5c5c5;
                left: 8px;
            }

            .timeline-item {
                position: relative;
                margin-bottom: 20px;
            }

            .timeline-marker {
                position: absolute;
                width: 16px;
                height: 16px;
                background: #0d6efd;
                border-radius: 50%;
                left: 0px;
                top: 5px;
            }

            .timeline-content {
                margin-left: 30px;
                padding: 10px 15px;
                background: #f8f9fa;
                border-radius: 5px;
                border: 1px solid #dee2e6;
            }

            .timeline-title {
                margin: 0 0 5px 0;
                font-size: 16px;
                font-weight: 600;
            }
        </style>
<script>
            function setupDropzone(zoneId, inputId, previewId) {
                const dropzone = document.getElementById(zoneId);
                const fileInput = document.getElementById(inputId);
                const previewArea = document.getElementById(previewId);

                if (!dropzone || !fileInput) return;

                dropzone.addEventListener("click", () => fileInput.click());

                dropzone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    dropzone.classList.add("bg-warning");
                });

                dropzone.addEventListener("dragleave", () => {
                    dropzone.classList.remove("bg-warning");
                });

                dropzone.addEventListener("drop", (e) => {
                    e.preventDefault();
                    dropzone.classList.remove("bg-warning");

                    const dt = new DataTransfer();
                    for (let i = 0; i &lt; e.dataTransfer.files.length; i++) {
                        dt.items.add(e.dataTransfer.files[i]);
                    }

                    fileInput.files = dt.files;

                    previewFiles(fileInput.files, previewArea);
                });


                fileInput.addEventListener("change", () => {
                    previewFiles(fileInput.files, previewArea);
                });
            }

            function previewFiles(files, previewArea) {
                previewArea.innerHTML = "";

                for (let file of files) {
                    let div = document.createElement("div");
                    div.className = "mt-2";

                    if (file.type.startsWith("image/")) {
                        let reader = new FileReader();
                        reader.onload = (e) => {
                            div.innerHTML = `
                                <img src="${e.target.result}" class="img-thumbnail" style="max-width:120px;"/>
                                <p>${file.name}</p>`;
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === "application/pdf") {
                        div.innerHTML = `<p>ðŸ“„ PDF: ${file.name}</p>`;
                    } else {
                        div.innerHTML = `<p>ðŸ“Ž ${file.name}</p>`;
                    }

                    previewArea.appendChild(div);
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                setupDropzone("dropzone-detail", "fileInput-detail", "previewArea-detail");
            });
            </script>
    </t>
</template>

</odoo>
