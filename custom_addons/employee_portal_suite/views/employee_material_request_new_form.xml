<?xml version="1.0" encoding="UTF-8"?>
<odoo>

<template id="employee_material_request_new_form" name="New Material Request Form">
<t t-call="employee_portal_suite.employee_portal_layout">
<style>
@media (max-width: 768px) {

    .table-responsive table,
    .table-responsive thead,
    .table-responsive tbody,
    .table-responsive th,
    .table-responsive td,
    .table-responsive tr {
        display: block;
        width: 100%;
    }

    .table-responsive thead {
        display: none;
    }

    .table-responsive tr {
        background: white;
        margin-bottom: 14px;
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }

    .table-responsive td {
        border: none !important;
        padding: 6px 0;
    }

    .table-responsive td::before {
        font-weight: 600;
        font-size: 12px;
        color: #9ca3af;
        display: block;
        margin-bottom: 4px;
    }

    .table-responsive td:nth-child(2)::before { content: "Item"; }
    .table-responsive td:nth-child(3)::before { content: "Qty"; }
    .table-responsive td:nth-child(4)::before { content: "UoM"; }
    .table-responsive td:nth-child(5)::before { content: "Actions"; }

}

</style>

<div class="container my-4">

    <h2 class="text-center mb-4">Material Request</h2>

    <!-- Language Toggle -->
    <div class="text-end mb-3">
        <button type="button" id="btn-en" class="btn btn-primary btn-sm">ğŸ‡¬ğŸ‡§ English</button>
        <button type="button" id="btn-ar" class="btn btn-light btn-sm">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>

    <!-- ===================== ENGLISH FORM ===================== -->
    <form id="form-en" method="post" action="/my/employee/material/create"
          enctype="multipart/form-data" style="display:block;">
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>Worksite <span class="text-danger">*</span></label>
            <input type="text" name="worksite" class="form-control" required="1"/>
        </div>

        <t t-set="min_delivery" t-value="(datetime.date.today() + datetime.timedelta(days=3)).isoformat()" />

        <div class="form-group mt-3">
            <label>Delivery Date <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date" class="form-control"
                   required="1" t-att-min="min_delivery"/>
        </div>

        <h4 class="mt-4">Materials</h4>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Item</th>
                        <th style="width:150px;">Qty</th>
                        <th style="width:180px;">UoM</th>
                        <th style="width:120px;" class="text-center">Actions</th>
                    </tr>
                </thead>

                <tbody id="material-lines-en">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0" class="form-control uom">
                                <option value="">Selectâ€¦</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">â˜</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-en"
                class="btn btn-success btn-sm mt-2">
            + Add Line
        </button>

        <!-- Attachments -->
        <h4 class="mt-4">Attachments</h4>

        <select name="attachment_tag"
                class="form-select mb-2" style="max-width:250px;">
            <option value="General">General</option>
            <option value="BOQ">BOQ</option>
            <option value="Quotation">Quotation</option>
            <option value="Image">Image</option>
            <option value="Receipt">Receipt</option>
        </select>

        <div id="dropzone"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                Drag and drop files here, or click to upload
            </p>
            <input type="file" name="attachments"
                   id="fileInput" class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea" class="mt-3"></div>

        <button type="submit" class="btn btn-primary mt-4">
            Submit
        </button>
    </form>

    <!-- ===================== ARABIC FORM ===================== -->
    <form id="form-ar" method="post"
          action="/my/employee/material/create"
          enctype="multipart/form-data"
          style="display:none; direction:rtl; text-align:right;">
        <input type="hidden" name="csrf_token"
               t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ <span class="text-danger">*</span></label>
            <input type="text" name="worksite"
                   class="form-control" required="1"/>
        </div>

        <div class="form-group mt-3">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date"
                   class="form-control" required="1"/>
        </div>

        <h4 class="mt-4">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h4>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th style="width:150px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th style="width:180px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th style="width:120px;" class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>

                <tbody id="material-lines-ar">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0"
                                    class="form-control uom">
                                <option value="">Ø§Ø®ØªØ±â€¦</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">â˜</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-ar"
                class="btn btn-success btn-sm mt-2">
            + Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±
        </button>

        <!-- Attachments AR -->
        <h4 class="mt-4">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h4>

        <select name="attachment_tag"
                class="form-select mb-2"
                style="max-width:250px;">
            <option value="General">Ø¹Ø§Ù…</option>
            <option value="BOQ">ÙƒÙ…ÙŠØ§Øª</option>
            <option value="Quotation">Ø¹Ø±Ø¶ Ø³Ø¹Ø±</option>
            <option value="Image">ØµÙˆØ±Ø©</option>
            <option value="Receipt">ÙØ§ØªÙˆØ±Ø©</option>
        </select>

        <div id="dropzone-ar"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹
            </p>
            <input type="file" name="attachments"
                   id="fileInput-ar"
                   class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea-ar" class="mt-3"></div>

        <button type="submit"
                class="btn btn-primary mt-4">
            Ø¥Ø±Ø³Ø§Ù„
        </button>
    </form>

</div>

<!-- ===================== JS ===================== -->
<script type="text/javascript">
<![CDATA[
document.addEventListener("DOMContentLoaded", function () {

    var btn_en = document.getElementById("btn-en");
    var btn_ar = document.getElementById("btn-ar");
    var form_en = document.getElementById("form-en");
    var form_ar = document.getElementById("form-ar");

    if (btn_en && btn_ar) {
        btn_en.onclick = function () {
            form_en.style.display = "block";
            form_ar.style.display = "none";
        };
        btn_ar.onclick = function () {
            form_en.style.display = "none";
            form_ar.style.display = "block";
        };
    }

    setupEnterprise("material-lines-en","add-line-en","form-en");
    setupEnterprise("material-lines-ar","add-line-ar","form-ar");

    function setupEnterprise(tbodyId, btnId, formId) {

        var tbody = document.getElementById(tbodyId);
        var addBtn = document.getElementById(btnId);
        var form = document.getElementById(formId);
        if (!tbody || !addBtn || !form) return;

        addBtn.addEventListener("click", function () {
            var first = tbody.querySelector("tr");
            var clone = first.cloneNode(true);

            var inputs = clone.querySelectorAll("input");
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].value = "";
            }

            clone.querySelector("select").value = "";
            tbody.appendChild(clone);
            renumber();
        });

        tbody.addEventListener("click", function(e){

            if (e.target.classList.contains("remove-line")) {
                if (tbody.querySelectorAll("tr").length === 1){
                    alert("At least one line is required.");
                    return;
                }
                e.target.closest("tr").remove();
                renumber();
            }

            if (e.target.classList.contains("copy-line")) {
                var row = e.target.closest("tr");
                var clone = row.cloneNode(true);
                tbody.insertBefore(clone,row.nextSibling);
                renumber();
            }
        });

        // DRAG
        var dragged;

        tbody.addEventListener("dragstart", function(e){
            dragged = e.target.closest("tr");
        });

        tbody.addEventListener("dragover", function(e){
            e.preventDefault();

            var rows = tbody.children;
            var after = null;

            for (var i = 0; i < rows.length; i++) {
                var rect = rows[i].getBoundingClientRect();
                if (e.clientY < rect.top + rect.height/2) {
                    after = rows[i];
                    break;
                }
            }

            if (after) {
                tbody.insertBefore(dragged, after);
            } else {
                tbody.appendChild(dragged);
            }
        });

        tbody.addEventListener("drop", function(){
            renumber();
        });

        function renumber(){
            var rows = tbody.querySelectorAll("tr");
            for (var i = 0; i < rows.length; i++) {

                rows[i].querySelector(".line-number").innerText = i + 1;
                rows[i].querySelector(".item-name").name = "item_name_" + i;
                rows[i].querySelector(".qty").name = "qty_required_" + i;
                rows[i].querySelector(".uom").name = "uom_id_" + i;
            }
        }

        form.addEventListener("submit", function(e){

            var names = tbody.querySelectorAll(".item-name");
            var valid = false;

            for (var i = 0; i < names.length; i++) {
                if (names[i].value.trim() !== "") {
                    valid = true;
                }
            }

            if (!valid){
                e.preventDefault();
                alert("You must enter at least one material line.");
            }

            renumber();
        });
    }

    // =====================
    // ATTACHMENT PREVIEW
    // =====================

    setupDropzone("dropzone","fileInput","previewArea");
    setupDropzone("dropzone-ar","fileInput-ar","previewArea-ar");

    function setupDropzone(zoneId,inputId,previewId){
        var zone=document.getElementById(zoneId);
        var input=document.getElementById(inputId);
        var preview=document.getElementById(previewId);
        if(!zone || !input)return;

        zone.onclick=function(){ input.click(); };

        input.onchange=function(){
            previewFiles(input.files,preview);
        };

        zone.ondragover=function(e){
            e.preventDefault();
            zone.classList.add("bg-warning");
        };

        zone.ondragleave=function(){
            zone.classList.remove("bg-warning");
        };

        zone.ondrop=function(e){
            e.preventDefault();
            zone.classList.remove("bg-warning");
            input.files=e.dataTransfer.files;
            previewFiles(input.files,preview);
        };
    }

    function previewFiles(files,preview){
        preview.innerHTML="";
        for(var i=0;i<files.length;i++){
            var file=files[i];
            var div=document.createElement("div");
            div.className="mt-2";

            if(file.type.indexOf("image/")===0){
                var reader=new FileReader();
                reader.onload=function(e){
                    div.innerHTML='<img src="'+e.target.result+
                    '" class="img-thumbnail" style="max-width:120px;"/><p>'+file.name+'</p>';
                };
                reader.readAsDataURL(file);
            }else{
                div.innerHTML="<p>ğŸ“ "+file.name+"</p>";
            }
            preview.appendChild(div);
        }
    }

});
]]>
</script>


</t>
</template>

</odoo>
