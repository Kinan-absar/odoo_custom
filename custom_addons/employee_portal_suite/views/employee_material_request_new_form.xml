<?xml version="1.0" encoding="UTF-8"?>
<odoo>

<template id="employee_material_request_new_form" name="New Material Request Form">
<t t-call="employee_portal_suite.employee_portal_layout">

<div class="container my-4">

    <h2 class="text-center mb-4">Material Request</h2>

    <!-- Language Toggle -->
    <div class="text-end mb-3">
        <button type="button" id="btn-en" class="btn btn-primary btn-sm">ğŸ‡¬ğŸ‡§ English</button>
        <button type="button" id="btn-ar" class="btn btn-light btn-sm">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>

    <!-- ===================== ENGLISH FORM ===================== -->
    <form id="form-en" method="post" action="/my/employee/material/create"
          enctype="multipart/form-data" style="display:block;">
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>Worksite <span class="text-danger">*</span></label>
            <input type="text" name="worksite" class="form-control" required="1"/>
        </div>

        <t t-set="min_delivery" t-value="(datetime.date.today() + datetime.timedelta(days=3)).isoformat()" />

        <div class="form-group mt-3">
            <label>Delivery Date <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date" class="form-control"
                   required="1" t-att-min="min_delivery"/>
        </div>

        <h4 class="mt-4">Materials</h4>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Item</th>
                        <th style="width:150px;">Qty</th>
                        <th style="width:180px;">UoM</th>
                        <th style="width:120px;" class="text-center">Actions</th>
                    </tr>
                </thead>

                <tbody id="material-lines-en">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0" class="form-control uom">
                                <option value="">Selectâ€¦</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">â˜</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-en"
                class="btn btn-success btn-sm mt-2">
            + Add Line
        </button>

        <!-- Attachments -->
        <h4 class="mt-4">Attachments</h4>

        <select name="attachment_tag"
                class="form-select mb-2" style="max-width:250px;">
            <option value="General">General</option>
            <option value="BOQ">BOQ</option>
            <option value="Quotation">Quotation</option>
            <option value="Image">Image</option>
            <option value="Receipt">Receipt</option>
        </select>

        <div id="dropzone"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                Drag and drop files here, or click to upload
            </p>
            <input type="file" name="attachments"
                   id="fileInput" class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea" class="mt-3"></div>

        <button type="submit" class="btn btn-primary mt-4">
            Submit
        </button>
    </form>

    <!-- ===================== ARABIC FORM ===================== -->
    <form id="form-ar" method="post"
          action="/my/employee/material/create"
          enctype="multipart/form-data"
          style="display:none; direction:rtl; text-align:right;">
        <input type="hidden" name="csrf_token"
               t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ <span class="text-danger">*</span></label>
            <input type="text" name="worksite"
                   class="form-control" required="1"/>
        </div>

        <div class="form-group mt-3">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date"
                   class="form-control" required="1"/>
        </div>

        <h4 class="mt-4">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h4>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th style="width:150px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th style="width:180px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th style="width:120px;" class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>

                <tbody id="material-lines-ar">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0"
                                    class="form-control uom">
                                <option value="">Ø§Ø®ØªØ±â€¦</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">â˜</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-ar"
                class="btn btn-success btn-sm mt-2">
            + Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±
        </button>

        <!-- Attachments AR -->
        <h4 class="mt-4">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h4>

        <select name="attachment_tag"
                class="form-select mb-2"
                style="max-width:250px;">
            <option value="General">Ø¹Ø§Ù…</option>
            <option value="BOQ">ÙƒÙ…ÙŠØ§Øª</option>
            <option value="Quotation">Ø¹Ø±Ø¶ Ø³Ø¹Ø±</option>
            <option value="Image">ØµÙˆØ±Ø©</option>
            <option value="Receipt">ÙØ§ØªÙˆØ±Ø©</option>
        </select>

        <div id="dropzone-ar"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹
            </p>
            <input type="file" name="attachments"
                   id="fileInput-ar"
                   class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea-ar" class="mt-3"></div>

        <button type="submit"
                class="btn btn-primary mt-4">
            Ø¥Ø±Ø³Ø§Ù„
        </button>
    </form>

</div>

<!-- ===================== JS ===================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    // =====================
    // LANGUAGE SWITCH
    // =====================
    btn_en.onclick = () => {
        form_en.style.display = "block";
        form_ar.style.display = "none";
    };
    btn_ar.onclick = () => {
        form_en.style.display = "none";
        form_ar.style.display = "block";
    };

    setupEnterprise("material-lines-en","add-line-en","form-en");
    setupEnterprise("material-lines-ar","add-line-ar","form-ar");

    function setupEnterprise(tbodyId, btnId, formId) {

        const tbody = document.getElementById(tbodyId);
        const addBtn = document.getElementById(btnId);
        const form = document.getElementById(formId);
        if (!tbody) return;

        addBtn.addEventListener("click", () => {
            const first = tbody.querySelector("tr");
            const clone = first.cloneNode(true);
            clone.querySelectorAll("input").forEach(i => i.value="");
            clone.querySelector("select").value="";
            tbody.appendChild(clone);
            renumber();
        });

        tbody.addEventListener("click", e => {
            if (e.target.classList.contains("remove-line")) {
                if (tbody.querySelectorAll("tr").length===1){
                    alert("At least one line is required.");
                    return;
                }
                e.target.closest("tr").remove();
                renumber();
            }

            if (e.target.classList.contains("copy-line")) {
                const row = e.target.closest("tr");
                const clone = row.cloneNode(true);
                tbody.insertBefore(clone,row.nextSibling);
                renumber();
            }
        });

        // Drag
        let dragged;
        tbody.addEventListener("dragstart", e=>{
            dragged = e.target.closest("tr");
        });
        tbody.addEventListener("dragover", e=>{
            e.preventDefault();
            const after = [...tbody.children]
                .find(row => e.clientY < row.getBoundingClientRect().top + row.offsetHeight/2);
            if (after) tbody.insertBefore(dragged,after);
            else tbody.appendChild(dragged);
        });
        tbody.addEventListener("drop", renumber);

        function renumber(){
            [...tbody.querySelectorAll("tr")].forEach((row,i)=>{
                row.querySelector(".line-number").innerText=i+1;
                row.querySelector(".item-name").name=`item_name_${i}`;
                row.querySelector(".qty").name=`qty_required_${i}`;
                row.querySelector(".uom").name=`uom_id_${i}`;
            });
        }

        form.addEventListener("submit", e=>{
            const names=[...tbody.querySelectorAll(".item-name")];
            const valid=names.some(n=>n.value.trim()!=="");
            if(!valid){
                e.preventDefault();
                alert("You must enter at least one material line.");
            }
            renumber();
        });
    }

    // =====================
    // ATTACHMENT PREVIEW
    // =====================
    setupDropzone("dropzone","fileInput","previewArea");
    setupDropzone("dropzone-ar","fileInput-ar","previewArea-ar");

    function setupDropzone(zoneId,inputId,previewId){
        const zone=document.getElementById(zoneId);
        const input=document.getElementById(inputId);
        const preview=document.getElementById(previewId);
        if(!zone)return;

        zone.onclick=()=>input.click();

        input.onchange=()=>previewFiles(input.files,preview);

        zone.ondragover=e=>{
            e.preventDefault();
            zone.classList.add("bg-warning");
        };
        zone.ondragleave=()=>zone.classList.remove("bg-warning");
        zone.ondrop=e=>{
            e.preventDefault();
            zone.classList.remove("bg-warning");
            input.files=e.dataTransfer.files;
            previewFiles(input.files,preview);
        };
    }

    function previewFiles(files,preview){
        preview.innerHTML="";
        for(let file of files){
            let div=document.createElement("div");
            div.className="mt-2";
            if(file.type.startsWith("image/")){
                let reader=new FileReader();
                reader.onload=e=>{
                    div.innerHTML=`<img src="${e.target.result}"
                    class="img-thumbnail"
                    style="max-width:120px;"/><p>${file.name}</p>`;
                };
                reader.readAsDataURL(file);
            }else{
                div.innerHTML=`<p>ğŸ“ ${file.name}</p>`;
            }
            preview.appendChild(div);
        }
    }

});
</script>

</t>
</template>

</odoo>
