<?xml version="1.0" encoding="UTF-8"?>
<odoo>

<template id="employee_material_request_new_form" name="New Material Request Form">
<t t-call="employee_portal_suite.employee_portal_layout">
<style>
/* =============================== */
/* MOBILE MATERIAL LINE CARDS     */
/* =============================== */

@media (max-width: 768px) {

    .mobile-line-card {
        background: white;
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }

    .mobile-line-header {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 12px;
    }

    .mobile-label {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
        display: block;
    }

    .mobile-line-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

}

</style>
<div class="container my-4">

    <h2 class="text-center mb-4">Material Request</h2>

    <!-- Language Toggle -->
    <div class="text-end mb-3">
        <button type="button" id="btn-en" class="btn btn-primary btn-sm">üá¨üáß English</button>
        <button type="button" id="btn-ar" class="btn btn-light btn-sm">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
    </div>

    <!-- ===================== ENGLISH FORM ===================== -->
    <form id="form-en" method="post" action="/my/employee/material/create"
          enctype="multipart/form-data" style="display:block;">
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>Worksite <span class="text-danger">*</span></label>
            <input type="text" name="worksite" class="form-control" required="1"/>
        </div>

        <t t-set="min_delivery" t-value="(datetime.date.today() + datetime.timedelta(days=3)).isoformat()" />

        <div class="form-group mt-3">
            <label>Delivery Date <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date" class="form-control"
                   required="1" t-att-min="min_delivery"/>
        </div>

        <h4 class="mt-4">Materials</h4>

        <div class="table-responsive d-none d-md-block">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Item</th>
                        <th style="width:150px;">Qty</th>
                        <th style="width:180px;">UoM</th>
                        <th style="width:120px;" class="text-center">Actions</th>
                    </tr>
                </thead>

                <tbody id="material-lines-en">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0" class="form-control uom">
                                <option value="">Select‚Ä¶</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">‚éò</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">√ó</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-en"
                class="btn btn-success btn-sm mt-2">
            + Add Line
        </button>
        <!-- MOBILE MATERIAL LINES -->
<div class="d-md-none" id="mobile-material-lines-en">

    <div class="mobile-line-card" data-index="0">
        <div class="mobile-line-header">
            <span class="mobile-line-number">Line 1</span>
        </div>

        <div class="mb-2">
            <label class="mobile-label">Item</label>
            <input type="text"
                   class="form-control item-name"
                   name="item_name_0"
                   required="1"/>
        </div>

        <div class="row g-2">
            <div class="col-6">
                <label class="mobile-label">Qty</label>
                <input type="number"
                       class="form-control qty"
                       name="qty_required_0"
                       min="0"/>
            </div>

            <div class="col-6">
                <label class="mobile-label">UoM</label>
                <select name="uom_id_0"
                        class="form-control uom">
                    <option value="">Select‚Ä¶</option>
                    <t t-foreach="uoms" t-as="u">
                        <option t-att-value="u.id">
                            <t t-esc="u.name"/>
                        </option>
                    </t>
                </select>
            </div>
        </div>

        <div class="mobile-line-actions mt-3">
            <button type="button"
                    class="btn btn-outline-secondary btn-sm copy-line">Copy</button>

            <button type="button"
                    class="btn btn-outline-danger btn-sm remove-line">Remove</button>
        </div>
    </div>

</div>

<button type="button"
        id="add-line-mobile-en"
        class="btn btn-success btn-sm mt-3 d-md-none">
    + Add Line
</button>

        <!-- Attachments -->
        <h4 class="mt-4">Attachments</h4>

        <select name="attachment_tag"
                class="form-select mb-2" style="max-width:250px;">
            <option value="General">General</option>
            <option value="BOQ">BOQ</option>
            <option value="Quotation">Quotation</option>
            <option value="Image">Image</option>
            <option value="Receipt">Receipt</option>
        </select>

        <div id="dropzone"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                Drag and drop files here, or click to upload
            </p>
            <input type="file" name="attachments"
                   id="fileInput" class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea" class="mt-3"></div>

        <button type="submit" class="btn btn-primary mt-4">
            Submit
        </button>
    </form>

    <!-- ===================== ARABIC FORM ===================== -->
    <form id="form-ar" method="post"
          action="/my/employee/material/create"
          enctype="multipart/form-data"
          style="display:none; direction:rtl; text-align:right;">
        <input type="hidden" name="csrf_token"
               t-att-value="request.csrf_token()"/>

        <div class="form-group mt-3">
            <label>ÿßŸÑŸÖŸàŸÇÿπ <span class="text-danger">*</span></label>
            <input type="text" name="worksite"
                   class="form-control" required="1"/>
        </div>

        <div class="form-group mt-3">
            <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ <span class="text-danger">*</span></label>
            <input type="date" name="delivery_date"
                   class="form-control" required="1"/>
        </div>

        <h4 class="mt-4">ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©</h4>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>ÿßŸÑÿµŸÜŸÅ</th>
                        <th style="width:150px;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                        <th style="width:180px;">ÿßŸÑŸàÿ≠ÿØÿ©</th>
                        <th style="width:120px;" class="text-center">ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                </thead>

                <tbody id="material-lines-ar">
                    <tr draggable="true">
                        <td class="line-number text-center">1</td>
                        <td>
                            <input type="text" class="form-control item-name"
                                   name="item_name_0" required="1"/>
                        </td>
                        <td>
                            <input type="number" class="form-control qty"
                                   name="qty_required_0" min="0"/>
                        </td>
                        <td>
                            <select name="uom_id_0"
                                    class="form-control uom">
                                <option value="">ÿßÿÆÿ™ÿ±‚Ä¶</option>
                                <t t-foreach="uoms" t-as="u">
                                    <option t-att-value="u.id">
                                        <t t-esc="u.name"/>
                                    </option>
                                </t>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-secondary btn-sm copy-line">‚éò</button>
                            <button type="button"
                                    class="btn btn-danger btn-sm remove-line">√ó</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" id="add-line-ar"
                class="btn btn-success btn-sm mt-2">
            + ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ∑ÿ±
        </button>

        <!-- Attachments AR -->
        <h4 class="mt-4">ÿßŸÑŸÖÿ±ŸÅŸÇÿßÿ™</h4>

        <select name="attachment_tag"
                class="form-select mb-2"
                style="max-width:250px;">
            <option value="General">ÿπÿßŸÖ</option>
            <option value="BOQ">ŸÉŸÖŸäÿßÿ™</option>
            <option value="Quotation">ÿπÿ±ÿ∂ ÿ≥ÿπÿ±</option>
            <option value="Image">ÿµŸàÿ±ÿ©</option>
            <option value="Receipt">ŸÅÿßÿ™Ÿàÿ±ÿ©</option>
        </select>

        <div id="dropzone-ar"
             class="border rounded p-4 text-center bg-light"
             style="cursor:pointer;">
            <p class="text-muted mb-0">
                ÿßÿ≥ÿ≠ÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸáŸÜÿß ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ±ŸÅÿπ
            </p>
            <input type="file" name="attachments"
                   id="fileInput-ar"
                   class="d-none" multiple="multiple"/>
        </div>

        <div id="previewArea-ar" class="mt-3"></div>

        <button type="submit"
                class="btn btn-primary mt-4">
            ÿ•ÿ±ÿ≥ÿßŸÑ
        </button>
    </form>

</div>

<!-- ===================== JS ===================== -->
<script type="text/javascript">
<![CDATA[
document.addEventListener("DOMContentLoaded", function () {

    var btn_en = document.getElementById("btn-en");
    var btn_ar = document.getElementById("btn-ar");
    var form_en = document.getElementById("form-en");
    var form_ar = document.getElementById("form-ar");

    if (btn_en && btn_ar) {
        btn_en.onclick = function () {
            form_en.style.display = "block";
            form_ar.style.display = "none";
        };
        btn_ar.onclick = function () {
            form_en.style.display = "none";
            form_ar.style.display = "block";
        };
    }

    setupEnterprise("material-lines-en","add-line-en","form-en");
    setupEnterprise("material-lines-ar","add-line-ar","form-ar");

    function setupEnterprise(tbodyId, btnId, formId) {

        var tbody = document.getElementById(tbodyId);
        var addBtn = document.getElementById(btnId);
        var form = document.getElementById(formId);
        if (!tbody || !addBtn || !form) return;

        addBtn.addEventListener("click", function () {
            var first = tbody.querySelector("tr");
            var clone = first.cloneNode(true);

            var inputs = clone.querySelectorAll("input");
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].value = "";
            }

            clone.querySelector("select").value = "";
            tbody.appendChild(clone);
            renumber();
        });

        tbody.addEventListener("click", function(e){

            if (e.target.classList.contains("remove-line")) {
                if (tbody.querySelectorAll("tr").length === 1){
                    alert("At least one line is required.");
                    return;
                }
                e.target.closest("tr").remove();
                renumber();
            }

            if (e.target.classList.contains("copy-line")) {
                var row = e.target.closest("tr");
                var clone = row.cloneNode(true);
                tbody.insertBefore(clone,row.nextSibling);
                renumber();
            }
        });

        // DRAG
        var dragged;

        tbody.addEventListener("dragstart", function(e){
            dragged = e.target.closest("tr");
        });

        tbody.addEventListener("dragover", function(e){
            e.preventDefault();

            var rows = tbody.children;
            var after = null;

            for (var i = 0; i < rows.length; i++) {
                var rect = rows[i].getBoundingClientRect();
                if (e.clientY < rect.top + rect.height/2) {
                    after = rows[i];
                    break;
                }
            }

            if (after) {
                tbody.insertBefore(dragged, after);
            } else {
                tbody.appendChild(dragged);
            }
        });

        tbody.addEventListener("drop", function(){
            renumber();
        });

        function renumber(){
            var rows = tbody.querySelectorAll("tr");
            for (var i = 0; i < rows.length; i++) {

                rows[i].querySelector(".line-number").innerText = i + 1;
                rows[i].querySelector(".item-name").name = "item_name_" + i;
                rows[i].querySelector(".qty").name = "qty_required_" + i;
                rows[i].querySelector(".uom").name = "uom_id_" + i;
            }
        }

        form.addEventListener("submit", function(e){

            var names = tbody.querySelectorAll(".item-name");
            var valid = false;

            for (var i = 0; i < names.length; i++) {
                if (names[i].value.trim() !== "") {
                    valid = true;
                }
            }

            if (!valid){
                e.preventDefault();
                alert("You must enter at least one material line.");
            }

            renumber();
        });
    }

    // =====================
    // ATTACHMENT PREVIEW
    // =====================

    setupDropzone("dropzone","fileInput","previewArea");
    setupDropzone("dropzone-ar","fileInput-ar","previewArea-ar");

    function setupDropzone(zoneId,inputId,previewId){
        var zone=document.getElementById(zoneId);
        var input=document.getElementById(inputId);
        var preview=document.getElementById(previewId);
        if(!zone || !input)return;

        zone.onclick=function(){ input.click(); };

        input.onchange=function(){
            previewFiles(input.files,preview);
        };

        zone.ondragover=function(e){
            e.preventDefault();
            zone.classList.add("bg-warning");
        };

        zone.ondragleave=function(){
            zone.classList.remove("bg-warning");
        };

        zone.ondrop=function(e){
            e.preventDefault();
            zone.classList.remove("bg-warning");
            input.files=e.dataTransfer.files;
            previewFiles(input.files,preview);
        };
    }

    function previewFiles(files,preview){
        preview.innerHTML="";
        for(var i=0;i<files.length;i++){
            var file=files[i];
            var div=document.createElement("div");
            div.className="mt-2";

            if(file.type.indexOf("image/")===0){
                var reader=new FileReader();
                reader.onload=function(e){
                    div.innerHTML='<img src="'+e.target.result+
                    '" class="img-thumbnail" style="max-width:120px;"/><p>'+file.name+'</p>';
                };
                reader.readAsDataURL(file);
            }else{
                div.innerHTML="<p>üìé "+file.name+"</p>";
            }
            preview.appendChild(div);
        }
    }

});
]]>
</script>


</t>
</template>

</odoo>
