<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- ===================================================== -->
    <!-- LIST VIEW -->
    <!-- ===================================================== -->
    <template id="portal_petty_cash_list" name="Petty Cash List">
        <t t-call="employee_portal_suite.employee_portal_layout">
            <div class="container mt-4">

                <h2>My Petty Cash Reports</h2>

                <!-- Create Report -->
                <form action="/my/petty-cash/create"
                      method="post"
                      class="mb-3">

                    <input type="hidden"
                           name="csrf_token"
                           t-att-value="request.csrf_token()"/>

                    <button type="submit"
                            class="btn btn-primary">
                        + New Petty Cash Report
                    </button>
                </form>

                <!-- Reports Table -->
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="reports" t-as="report">
                            <tr>
                                <td>
                                    <a t-att-href="'/my/petty-cash/%s' % report.id">
                                        <t t-esc="report.name"/>
                                    </a>
                                </td>
                                <td><t t-esc="report.date"/></td>
                                <td><t t-esc="report.amount_total"/></td>
                                <td>
                                    <span class="badge"
                                        t-att-class="{
                                            'bg-light text-dark border': report.state == 'draft',
                                            'bg-warning text-dark': report.state == 'submitted',
                                            'bg-success': report.state == 'approved',
                                            'bg-danger': report.state == 'rejected'
                                        }">
                                        <t t-esc="report.state.capitalize()"/>
                                    </span>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

            </div>
        </t>
    </template>


    <!-- ===================================================== -->
    <!-- DETAIL VIEW -->
    <!-- ===================================================== -->
    <template id="portal_petty_cash_detail" name="Petty Cash Detail">
        <t t-call="employee_portal_suite.employee_portal_layout">

            <div class="container mt-4">

                <!-- Back Button -->
                <a href="/my/petty-cash"
                   class="btn btn-secondary mb-3">
                    ‚Üê Back
                </a>

                <!-- Inline Error -->
                <t t-if="request.params.get('error') == 'no_lines'">
                    <div class="alert alert-danger">
                        You cannot submit a petty cash report without expense lines.
                    </div>
                </t>
                <t t-if="request.params.get('success') == 'uploaded'">
                    <div class="alert alert-success">
                        Attachment uploaded successfully.
                    </div>
                </t>

                <h2>
                    Petty Cash Report
                    <t t-esc="report.name"/>
                </h2>

                <p>
                    <strong>Date:</strong>
                    <t t-esc="report.date"/>
                </p>

                <p>
                    <strong>Status:</strong>
                    <span class="badge"
                           t-att-class="{
                            'bg-light text-dark border': report.state == 'draft',
                            'bg-warning text-dark': report.state == 'submitted',
                            'bg-success': report.state == 'approved',
                            'bg-danger': report.state == 'rejected'
                        }">
                        <t t-esc="report.state.capitalize()"/>
                    </span>
                </p>

                <p>
                    <strong>Total:</strong>
                    <t t-esc="report.amount_total"/>
                </p>
                 <t t-if="report.state == 'draft'">

                    <h5 class="mt-4">Report Attachments</h5>

                    <form t-att-action="'/my/petty-cash/%s/upload-attachment' % report.id"
                        method="post"
                        enctype="multipart/form-data"
                        class="mb-3">

                        <input type="hidden"
                            name="csrf_token"
                            t-att-value="request.csrf_token()"/>

                        <div class="input-group">
                            <input type="file"
                                name="attachment"
                                class="form-control"
                                required="required"/>
                            <button type="submit"
                                    class="btn btn-outline-primary">
                                Upload
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            Please upload all invoices combined in one PDF file.
                        </small>

                    </form>

                </t>
                <t t-if="report.attachment_ids">
                    <h5 class="mt-3">Uploaded Attachments</h5>

                    <ul class="list-group mb-4">
                        <t t-foreach="report.attachment_ids" t-as="att">
                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <div>
                                    üìé 
                                   <a t-att-href="'/web/content/%s' % att.id"
                                    target="_blank">
                                        <t t-esc="att.name"/>
                                    </a>
                                </div>
                                                <!-- Delete Button (Draft Only) -->
                                <t t-if="report.state == 'draft'">
                                    <form t-att-action="'/my/petty-cash/attachment/%s/delete' % att.id"
                                        method="post"
                                        class="d-inline">

                                        <input type="hidden"
                                            name="csrf_token"
                                            t-att-value="request.csrf_token()"/>

                                         <button type="submit"
                                                class="border-0 bg-transparent text-danger fw-bold"
                                                style="font-size: 18px;"
                                                title="Delete">
                                            √ó
                                        </button>

                                    </form>
                                </t>
                            </li>
                        </t>
                    </ul>
                </t>

                <h4 class="mt-4">Expense Lines</h4>
               
                <!-- Expense Lines Table -->
                <form t-att-action="'/my/petty-cash/%s/add-line' % report.id"
                      method="post"
                      enctype="multipart/form-data">

                    <input type="hidden"
                           name="csrf_token"
                           t-att-value="request.csrf_token()"/>

                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Details</th>
                                <th>Category</th>
                                <th>Untaxed</th>
                                <th>VAT</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>

                            <!-- Existing Lines -->
                            <t t-foreach="report.line_ids" t-as="line">
                                <tr>
                                    <td><t t-esc="line.date"/></td>
                                    <td>
                                        <strong><t t-esc="line.description"/></strong><br/>
                                        <small>
                                            Supplier: <t t-esc="line.supplier or '-'"/><br/>
                                            Invoice: <t t-esc="line.invoice_number or '-'"/><br/>
                                            PO: <t t-esc="line.po_number or '-'"/><br/>
                                            MR: <t t-esc="line.mr_number or '-'"/><br/>
                                            Zone: <t t-esc="line.zone or '-'"/>
                                        </small>
                                    </td>
                                    <td><t t-esc="line.category_id.name"/></td>
                                    <td><t t-esc="line.amount_before_vat"/></td>
                                    <td><t t-esc="line.vat_amount"/></td>
                                    <td><t t-esc="line.amount_total"/></td>
                                    <td></td>
                                </tr>
                            </t>

                            <!-- Inline Add Row -->
                            <t t-if="report.state == 'draft'">
                                <tr>

                                    <td>
                                        <input type="date"
                                               name="date"
                                               class="form-control"
                                               required="required"/>
                                    </td>

                                    <td>
                                        <input type="text"
                                               name="description"
                                               class="form-control mb-1"
                                               placeholder="Description"/>

                                        <input type="text"
                                               name="supplier"
                                               class="form-control mb-1"
                                               placeholder="Supplier"/>

                                        <input type="text"
                                               name="invoice_number"
                                               class="form-control mb-1"
                                               placeholder="Invoice No"/>

                                        <input type="text"
                                               name="po_number"
                                               class="form-control mb-1"
                                               placeholder="PO No"/>

                                        <input type="text"
                                               name="mr_number"
                                               class="form-control mb-1"
                                               placeholder="MR No"/>

                                        <input type="text"
                                               name="zone"
                                               class="form-control"
                                               placeholder="Zone"/>
                                    </td>

                                    <td>
                                        <select name="category_id"
                                                class="form-control"
                                                required="required">
                                            <t t-foreach="categories" t-as="cat">
                                                <option t-att-value="cat.id">
                                                    <t t-esc="cat.name"/>
                                                </option>
                                            </t>
                                        </select>
                                    </td>

                                    <td>
                                        <input type="number"
                                               step="0.01"
                                               name="amount_before_vat"
                                               class="form-control"
                                               required="required"/>
                                    </td>

                                    <td class="text-center">
                                        <input type="checkbox"
                                               name="vat_applicable"
                                               checked="checked"/>
                                    </td>

                                    <td>-</td>

                                    <td>
                                        <button type="submit"
                                                class="btn btn-success btn-sm">
                                            Add
                                        </button>
                                    </td>

                                </tr>
                            </t>

                        </tbody>
                    </table>

                </form>

                <!-- Submit Button -->
                <t t-if="report.state == 'draft'">
                    <form t-att-action="'/my/petty-cash/%s/submit' % report.id"
                          method="post"
                          class="mt-3">

                        <input type="hidden"
                               name="csrf_token"
                               t-att-value="request.csrf_token()"/>

                        <button type="submit"
                                class="btn btn-warning">
                            Submit Report
                        </button>
                    </form>
                </t>

            </div>
        </t>
    </template>

</odoo>
